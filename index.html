<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadriga Agent (Super-Zoom Architecture)</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #222; color: white; overflow: hidden; }
        
        #call-container { width: 100vw; height: 100vh; position: relative; }

        #media-overlay {
            display: none; position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; max-width: 800px;
            max-height: min(700px, 90vh);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 999;
            text-align: center;
            flex-direction: column;
            align-items: center;
            transition: border 0.2s ease-in-out;
            border: 4px solid transparent; 
            overflow: hidden; 
        }

        #instructional-image, #instructional-video {
            width: auto; max-width: 100%;
            max-height: 550px; max-height: 60vh;
            object-fit: contain; border-radius: 8px; 
            display: none;
            
            /* PERFORMANCE FIX: Forces browser to use GPU for 10x magnification */
            image-rendering: high-quality;
            will-change: transform, transform-origin;

            /* SMOOTHING FIX: 0.4s cubic-bezier ensures rapid tool calls feel like a smooth pan */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                        transform-origin 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        #close-btn {
            margin-top: 15px; padding: 10px 20px;
            background: #ff4444; color: white; 
            border: none; border-radius: 4px; 
            cursor: pointer; font-size: 16px;
            flex-shrink: 0; z-index: 1001;
        }
        #close-btn:hover { background: #cc0000; }
        
        #status-log {
            position: absolute; bottom: 20px; right: 20px;
            color: #aaa; font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px; border-radius: 4px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="call-container"></div>

    <div id="media-overlay">
        <img id="instructional-image" src="" alt="Instructional Aid" />
        <video id="instructional-video" playsinline>
            <source src="" type="video/mp4">
        </video>
        <br/>
        <button id="close-btn" onclick="closeOverlay()">Close Media</button>
    </div>

    <div id="status-log">Ready</div>

    <script>
        const ROOM_URL = "https://resqhealth.daily.co/quadriga-agent-test"; 
        let callFrame = null;

        async function startCall() {
            callFrame = window.DailyIframe.createFrame(
                document.getElementById('call-container'), {
                    showLeaveButton: true,
                    iframeStyle: { width: '100%', height: '100%', border: '0' }
                }
            );

            const vid = document.getElementById('instructional-video');
            
            vid.onended = () => {
                if (callFrame) callFrame.sendAppMessage({ event: "video_ended" });
            };

            callFrame.on('app-message', (e) => {
                if (!e.data) return;
                console.log("App Message:", e.data);
                updateStatus(`Event: ${e.data.event}`);

                if (e.data.event === 'show_image') {
                    showImage(e.data.url, e.data.zoom, e.data.pan_x, e.data.pan_y);
                }

                if (e.data.event === 'close_image') {
                    closeOverlay();
                }

                if (e.data.event === 'video_control' && e.data.command === 'pause') {
                    vid.pause();
                }

                if (e.data.event === 'update_video_state') {
                    handleAtomicVideoUpdate(e.data.state, e.data.url);
                }

                if (e.data.event === 'user_speaking_status') {
                    const overlay = document.getElementById('media-overlay');
                    if (overlay.style.display !== 'none' && !vid.paused) {
                        if (e.data.status === 'speaking') {
                            vid.volume = 0.2;
                            overlay.style.border = "4px solid #00ff00";
                        } else {
                            vid.volume = 1.0;
                            overlay.style.border = "4px solid transparent";
                        }
                    }
                }
            });

            try {
                await callFrame.join({ url: ROOM_URL });
            } catch (err) {
                console.error("Join failed:", err);
            }
        }

        function handleAtomicVideoUpdate(state, url) {
            const video = document.getElementById('instructional-video');
            const overlay = document.getElementById('media-overlay');
            const image = document.getElementById('instructional-image');

            if (url && video.src !== url) {
                image.style.display = 'none';
                video.style.display = 'block';
                video.src = url;
                overlay.style.display = 'flex'; 
                video.onloadedmetadata = () => applySynchronousState(video, state);
            } else if (overlay.style.display !== 'none') {
                applySynchronousState(video, state);
            }
        }

        function applySynchronousState(video, state) {
            console.log("Applying State:", state);

            // 1. Time Synchronization
            if (state.time_abs !== undefined && state.time_abs !== null) {
                video.currentTime = state.time_abs;
            } else if (state.time_rel) {
                video.currentTime += state.time_rel;
            }

            // 2. Audio Control (Mute + Precision Volume)
            if (state.muted !== undefined) video.muted = state.muted;
            if (state.volume !== undefined) video.volume = state.volume;

            // 3. Speed Control
            if (state.speed) video.playbackRate = state.speed;

            // 4. COORDINATE PANNING & ZOOM
            if (state.zoom !== undefined || state.pan_x !== undefined) {
                const z = state.zoom || 1.0;
                const px = state.pan_x !== undefined ? state.pan_x : 50;
                const py = state.pan_y !== undefined ? state.pan_y : 50;
                video.style.transformOrigin = `${px}% ${py}%`;
                video.style.transform = `scale(${z})`;
            }

            // 5. Playback State
            if (state.playing === true) {
                video.play().catch(e => console.warn("Autoplay blocked:", e));
            } else if (state.playing === false) {
                video.pause();
            }
        }

        function showImage(url, zoom = 1.0, pan_x = 50, pan_y = 50) {
            const box = document.getElementById('media-overlay');
            const img = document.getElementById('instructional-image');
            const vid = document.getElementById('instructional-video');
            vid.pause();
            vid.style.display = 'none';
            img.src = url;
            img.style.display = 'block';

            // ATOMIC TRANSFORMATION: Set origin and scale together for smooth panning
            img.style.transformOrigin = `${pan_x}% ${pan_y}%`;
            img.style.transform = `scale(${zoom})`;

            box.style.display = 'flex'; 
        }

        function closeOverlay() {
            const overlay = document.getElementById('media-overlay');
            const img = document.getElementById('instructional-image');
            const vid = document.getElementById('instructional-video');
            vid.pause();
            // Reset transforms so next load doesn't start from an offset
            img.style.transform = 'scale(1.0)';
            img.style.transformOrigin = '50% 50%';
            vid.style.transform = 'scale(1.0)';
            vid.style.transformOrigin = '50% 50%';
            overlay.style.display = 'none';
        }
        
        function updateStatus(text) {
            document.getElementById('status-log').textContent = text;
        }

        startCall();
    </script>
</body>
</html>