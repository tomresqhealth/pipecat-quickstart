<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadriga Agent (Atomic Architecture)</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #222; color: white; overflow: hidden; }
        
        /* The Video Container */
        #call-container {
            width: 100vw; height: 100vh;
            position: relative;
        }

        /* The Content Overlay (Images & Video) */
        #media-overlay {
            display: none; /* HIDDEN until triggered */
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; max-width: 800px;
            
            /* HEIGHT CONSTRAINTS */
            max-height: min(700px, 90vh);
            
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 999;
            text-align: center;
            flex-direction: column;
            align-items: center;
            
            transition: border 0.2s ease-in-out;
            border: 4px solid transparent; 
            
            overflow: hidden;
            overflow-y: auto; 
        }

        #instructional-image, #instructional-video {
            width: auto;
            max-width: 100%;
            max-height: 550px;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 8px; 
            display: none; 
        }

        #close-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #ff4444; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 16px;
            flex-shrink: 0;
        }
        #close-btn:hover { background: #cc0000; }
        
        #status-log {
            position: absolute;
            bottom: 20px; right: 20px;
            color: #aaa; font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 4px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="call-container"></div>

    <div id="media-overlay">
        <img id="instructional-image" src="" alt="Instructional Aid" />
        
        <video id="instructional-video" playsinline>
            <source src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <br/>
        <button id="close-btn" onclick="closeOverlay()">Close Media</button>
    </div>

    <div id="status-log">Ready</div>

    <script>
        const ROOM_URL = "https://resqhealth.daily.co/quadriga-agent-test"; 
        let callFrame = null;

        async function startCall() {
            callFrame = window.DailyIframe.createFrame(
                document.getElementById('call-container'), {
                    showLeaveButton: true,
                    iframeStyle: { width: '100%', height: '100%', border: '0' }
                }
            );

            const vid = document.getElementById('instructional-video');
            
            // Turn-Taking Notification
            vid.onended = () => {
                console.log("ðŸŽ¬ Video finished");
                if (callFrame) {
                    callFrame.sendAppMessage({ event: "video_ended" });
                }
            };

            callFrame.on('app-message', (e) => {
                if (!e.data) return;
                
                console.log("Received app-message:", e.data);
                updateStatus(`Event: ${e.data.event}`);

                if (e.data.event === 'show_image') {
                    showImage(e.data.url);
                }

                if (e.data.event === 'close_image') {
                    closeOverlay();
                }

                // 1. PANIC BUTTON: Low-latency stop
                if (e.data.event === 'video_control' && e.data.command === 'pause') {
                    vid.pause();
                }

                // 2. ATOMIC TRANSACTION: Unified state updates
                if (e.data.event === 'update_video_state') {
                    handleAtomicVideoUpdate(e.data.state, e.data.url);
                }

                // Audio Ducking (UX Optimization)
                if (e.data.event === 'user_speaking_status') {
                    const overlay = document.getElementById('media-overlay');
                    if (overlay.style.display !== 'none' && !vid.paused) {
                        if (e.data.status === 'speaking') {
                            vid.volume = 0.2;
                            overlay.style.border = "4px solid #00ff00";
                        } else {
                            vid.volume = 1.0;
                            overlay.style.border = "4px solid transparent";
                        }
                    }
                }
            });

            try {
                await callFrame.join({ url: ROOM_URL });
            } catch (err) {
                console.error("Failed to join room.", err);
            }
        }

        // PERFECTED ATOMIC STATE MANAGEMENT
        function handleAtomicVideoUpdate(state, url) {
            const video = document.getElementById('instructional-video');
            const overlay = document.getElementById('media-overlay');
            const image = document.getElementById('instructional-image');

            // 1. Handle New Media Source / Visibility
            if (url && video.src !== url) {
                console.log("Atomic: Loading new source", url);
                image.style.display = 'none';
                video.style.display = 'block';
                video.src = url;
                overlay.style.display = 'flex'; // Unhide automatically
                
                // WAIT FOR METADATA: Fixes "video didn't move" error
                video.onloadedmetadata = () => applySynchronousState(video, state);
            } else if (overlay.style.display !== 'none') {
                // Apply immediately to already-loaded video
                applySynchronousState(video, state);
            }
        }

        function applySynchronousState(video, state) {
            console.log("Syncing State Transaction:", state);

            // ORDER MATTERS: Time -> Speed -> Muted -> Play/Pause
            
            // 1. Time (Absolute has priority over Relative)
            if (state.time_abs !== undefined && state.time_abs !== null) {
                video.currentTime = state.time_abs;
            } else if (state.time_rel !== undefined && state.time_rel !== null) {
                video.currentTime += state.time_rel;
            }

            // 2. Speed
            if (state.speed !== undefined && state.speed !== null) {
                video.playbackRate = state.speed;
            }

            // 3. Mute
            if (state.muted !== undefined && state.muted !== null) {
                video.muted = state.muted;
            }

            // 4. Play/Pause State Last
            if (state.playing === true) {
                video.play().catch(e => console.warn("Auto-play blocked:", e));
            } else if (state.playing === false) {
                video.pause();
            }
        }

        function showImage(url) {
            const box = document.getElementById('media-overlay');
            const img = document.getElementById('instructional-image');
            const vid = document.getElementById('instructional-video');
            vid.pause();
            vid.style.display = 'none';
            img.src = url;
            img.style.display = 'block';
            box.style.display = 'flex'; 
        }

        function closeOverlay() {
            const overlay = document.getElementById('media-overlay');
            const vid = document.getElementById('instructional-video');
            vid.pause();
            overlay.style.display = 'none';
        }
        
        function updateStatus(text) {
            document.getElementById('status-log').textContent = text;
        }

        startCall();
    </script>
</body>
</html>